<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FHIR Document Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* Light theme defaults */
      --bg:#f7f9fc; --card:#ffffff; --muted:#5c6b7a; --text:#0b0e10; --brand:#0ea5e9;
      --chip:#eef2f7; --accent:#22c55e; --warn:#b45309; --border:#d6dee7;
      --focus:#0ea5e9; --code:#f1f5f9; --link:#0b6bcb;
      --header-h:56px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;padding-top:var(--header-h)}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
    .app{display:grid;grid-template-columns:280px 1fr}
    header.topbar{
      position:fixed;top:0;left:0;right:0;z-index:40;
      display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;
      padding:.75rem 1rem;background:linear-gradient(180deg,#ffffff 0%,#ffffffcc 100%);
      border-bottom:1px solid var(--border);backdrop-filter:saturate(1.2) blur(6px)
    }
    .brand{font-weight:700;letter-spacing:.2px}
    .brand .pill{padding:.18rem .5rem;border:1px solid var(--border);border-radius:999px;background:var(--card);margin-left:.5rem;font-size:.75rem;color:var(--muted)}
    .controls{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .controls input[type="text"]{min-width:280px}
    .controls input[type="text"], .controls input[type="url"], .controls .button, .controls label.button{
      background:var(--card);border:1px solid var(--border);color:var(--text);padding:.5rem .65rem;border-radius:.5rem
    }
    .controls .button{cursor:pointer}
    .controls input[type="file"]{display:none}
    .grow{flex:1}
    .layout{
      display:grid;grid-template-columns:280px 1fr;gap:0
    }
    aside.nav{
      position:sticky;top:var(--header-h);height:calc(100dvh - var(--header-h));overflow:auto;padding:1rem;border-right:1px solid var(--border);background:#f0f4f8
    }
    .nav h3{margin:.75rem 0 .5rem;font-size:.9rem;color:var(--muted)}
    .nav .group{margin-bottom:1rem}
    .nav ul{list-style:none;margin:0;padding:0}
    .nav li{margin:0}
    .nav a{display:block;padding:.35rem .5rem;border-radius:.35rem;color:var(--text)}
    .nav a:hover{background:var(--card)}
    main.content{padding:1rem 1rem 4rem;min-width:0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:.75rem;padding:1rem;margin-bottom:1rem}
    .meta{display:flex;gap:1rem;flex-wrap:wrap;color:var(--muted);font-size:.9rem}
    .section{
      scroll-margin-top:calc(var(--header-h) + 16px);margin-bottom:1.25rem;border:1px dashed var(--border);border-radius:.75rem;padding:1rem;background:#f7f9fc
    }
    .section h4{margin:0 0 .5rem}
    .chips{display:flex;gap:.4rem;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:.4ch;padding:.15rem .45rem;
      background:var(--chip);border:0;border-radius:.5rem;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;font-size:.85em;color:var(--text)
    }
    .chip .rt{opacity:.7}
    .resource{
      scroll-margin-top:calc(var(--header-h) + 16px)
    }
    .rhead{
      display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:.5rem
    }
    .rtitle{font-weight:700}
    .rtitle small{color:var(--muted);font-weight:500}
    .tabs{display:flex;gap:.25rem;border:1px solid var(--border);background:var(--bg);border-radius:.5rem;padding:.25rem;cursor:pointer}
    .tab{padding:.25rem .5rem;border-radius:.35rem;border:1px solid transparent;cursor:pointer}
    .tab[aria-selected="true"]{background:var(--card);border-color:var(--border)}
    pre.json{background:var(--code);color:var(--text);border:1px solid var(--border);border-radius:.5rem;padding:.75rem;overflow:auto;max-height:60vh}
    code.kv{background:var(--chip);padding:.1rem .3rem;border:1px solid var(--border);border-radius:.3rem}
    .kvrow{display:flex;gap:.6rem;align-items:baseline;white-space:nowrap}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:.65rem}
    .kvlist{display:flex;flex-wrap:wrap;gap:.75rem 1.5rem}
    .bigRow{display:flex;align-items:baseline;justify-content:flex-start;flex-wrap:wrap;column-gap:.75rem;row-gap:.1rem;margin-bottom:.25rem}
    .bigLabel{font-weight:600;font-size:1.05rem}
    .bigValue{font-weight:600;font-size:1.05rem}
    .muted{color:var(--muted)}
    .divider{height:1px;background:var(--border);margin:1.25rem 0}
    .btnlink{background:none;border:0;color:var(--link);cursor:pointer}
    .badge{display:inline-block;padding:0;border:0;border-radius:0;background:transparent;color:var(--muted);font-size:.85em}
    .hint{font-size:.9em;color:var(--muted)}
    .error{color:#ffd0d0}
    .search{display:flex;gap:.5rem;align-items:center;margin:.5rem 0 1rem}
    .stickyTop{position:sticky;top:var(--header-h);z-index:30;background:var(--bg);padding:.25rem 0}
    .reflist{margin-top:.25rem}
    .reftable{display:grid;grid-template-columns:140px 1fr;column-gap:1rem;row-gap:.2rem;align-items:baseline}
    .refkey{color:var(--muted)}
    .refvals{min-width:200px}
    .refsep{color:var(--muted);margin:0 .25rem}
    @media (max-width: 640px){
      .reftable{grid-template-columns:1fr}
    }
    @media (max-width: 980px){
      .app,.layout{grid-template-columns:1fr}
      aside.nav{position:static;height:auto;order:2;border-right:none;border-top:1px solid var(--border)}
    }
    @media print{
      header.topbar, aside.nav, .stickyTop, .controls {display:none !important}
      body{background:white;color:black}
      .card, .section{border-color:#999}
      .tabs{display:none}
      .summary, .jsonview{display:block !important}
      pre.json{max-height:none}
      a{color:inherit;text-decoration:none}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">FHIR Document Viewer <span class="pill">static • ESM</span></div>
    <div class="controls">
      <select id="exampleSelect" class="button" title="Load example" style="display:none">
        <option value="">Examples…</option>
      </select>
      <label class="button" title="Open a local Bundle (JSON)">
        <input id="fileInput" type="file" accept=".json,application/json" />
        Open File…
      </label>
      <button id="pasteBtn" class="button" title="Paste raw JSON">Paste JSON…</button>
      <input id="urlInput" type="url" placeholder="Load from URL (https://…/bundle.json)" />
      <button id="loadUrlBtn" class="button">Load URL</button>
      <input id="search" type="text" placeholder="Search resources…" />
      <button id="printModeBtn" class="button" title="Toggle print‑friendly mode">Print Mode</button>
    </div>
    <div class="grow"></div>
    <div class="hint">Tip: default loads <code>examples/pirate-angina.json</code></div>
  </header>

  <div id="root"></div>
  <div id="pasteModal" style="display:none"></div>

  <!-- React UMD + Babel for in-browser JSX compilation -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="react">
    const { useEffect, useMemo, useState, useRef } = React;
    const { createRoot } = ReactDOM;

    // ---------- Utilities ----------
    const isObj = (v) => v && typeof v === "object";
    const fmtDate = (v) => {
      if (!v) return "";
      try {
        const d = new Date(v);
        if (isNaN(d)) return v;
        return new Intl.DateTimeFormat(undefined, { dateStyle: "medium", timeStyle: v.includes("T") ? "short" : undefined }).format(d);
      } catch { return v; }
    };
    const ccDisplay = (cc) => {
      if (!cc) return "";
      if (cc.text) return cc.text;
      const c = (cc.coding && cc.coding[0]) || {};
      return c.display || [c.system, c.code].filter(Boolean).join(" | ");
    };
    const qtyDisplay = (q) => {
      if (!q) return "";
      const num = typeof q.value === "number" ? q.value : (q.value || "");
      return [num, q.unit || q.code].filter(Boolean).join(" ");
    };
    const humanName = (p) => {
      if (!p?.name || !p.name[0]) return "";
      const n = p.name[0];
      return [n.prefix?.join(" "), n.given?.join(" "), n.family].filter(Boolean).join(" ").replace(/\s+/g," ").trim();
    };
    const sanitizeHTML = (html) => {
      if (!html) return "";
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      tmp.querySelectorAll("script,style").forEach(n => n.remove());
      tmp.querySelectorAll("*").forEach(el => {
        [...el.attributes].forEach(a => {
          if (/^on/i.test(a.name)) el.removeAttribute(a.name);
        });
      });
      // Remove placeholder tokens like {{Plan}} or {{# Supportive Care}}
      tmp.innerHTML = tmp.innerHTML.replace(/\{\{[^}]+\}\}/g, "");
      return tmp.innerHTML;
    };

    function buildIndex(bundle){
      const byKey = new Map();
      const byFullUrl = new Map();
      const all = [];
      for (const e of bundle.entry || []) {
        if (!e?.resource) continue;
        const r = e.resource;
        const key = `${r.resourceType}/${r.id || ""}`;
        r.__anchor = r.__anchor || key;
        byKey.set(key, r);
        if (e.fullUrl) byFullUrl.set(e.fullUrl, r);
        all.push(r);
      }
      const composition = all.find(r => r.resourceType === "Composition");
      return { byKey, byFullUrl, all, composition };
    }

    function resolveReference(ref, index){
      if (!ref) return null;
      if (index.byKey.has(ref)) return index.byKey.get(ref);
      if (index.byFullUrl.has(ref)) return index.byFullUrl.get(ref);
      if (/^https?:/.test(ref)) {
        try {
          const u = new URL(ref);
          const parts = u.pathname.split("/").filter(Boolean);
          const key = `${parts[parts.length-2]}/${parts[parts.length-1]}`;
          if (index.byKey.has(key)) return index.byKey.get(key);
        } catch {}
      }
      return null;
    }

    function collectReferences(resource){
      const out = [];
      const seen = new Set();
      const walk = (node, path="")=>{
        if (Array.isArray(node)) return node.forEach((v,i)=>walk(v, `${path}[${i}]`));
        if (!isObj(node)) return;
        for (const [k,v] of Object.entries(node)){
          if (k === "reference" && typeof v === "string"){
            if (!seen.has(v)){ out.push({ref:v, path: path ? `${path}.${k}` : k}); seen.add(v); }
          } else {
            walk(v, path ? `${path}.${k}` : k);
          }
        }
      };
      walk(resource,"");
      return out;
    }

    const resourceKey = (r)=> `${r.resourceType}/${r.id || ""}`;

    function resourceSummaryText(r){
      const parts=[r.resourceType, r.id];
      switch(r.resourceType){
        case "Patient": parts.push(humanName(r), r.gender, r.birthDate); break;
        case "Practitioner": parts.push(humanName(r)); break;
        case "Condition": parts.push(ccDisplay(r.code), r.clinicalStatus?.coding?.[0]?.display); break;
        case "Observation": parts.push(ccDisplay(r.code), qtyDisplay(r.valueQuantity), r.valueString, ccDisplay(r.valueCodeableConcept)); break;
        case "ServiceRequest": parts.push(ccDisplay(r.code), r.status, r.priority); break;
        case "MedicationRequest": parts.push(ccDisplay(r.medicationCodeableConcept), r.status); break;
        case "MedicationStatement": parts.push(ccDisplay(r.medicationCodeableConcept), r.status); break;
        case "Encounter": parts.push(r.status, ccDisplay(r.class), fmtDate(r.period?.start)); break;
        case "Composition": parts.push(r.title, fmtDate(r.date)); break;
        default: parts.push(JSON.stringify(r.type || r.code || r.title || "").slice(0,80));
      }
      return parts.filter(Boolean).join(" ").toLowerCase();
    }

    // ---------- App ----------
    function App(){
      const [bundle, setBundle] = useState(null);
      const [err, setErr] = useState("");
      const [filter, setFilter] = useState("");
      const [printMode, setPrintMode] = useState(false);
      const [examples, setExamples] = useState([]);
      const [showPaste, setShowPaste] = useState(false);
      const [pasteText, setPasteText] = useState("");

      // Keep CSS --header-h in sync with actual header height
      useEffect(()=>{
        const updateHeaderVar = ()=>{
          const h = document.querySelector('header.topbar')?.offsetHeight || 56;
          document.documentElement.style.setProperty('--header-h', h + 'px');
        };
        updateHeaderVar();
        window.addEventListener('resize', updateHeaderVar);
        return ()=> window.removeEventListener('resize', updateHeaderVar);
      },[]);

      // Wire up topbar buttons that live outside React root for simplicity
      useEffect(()=>{
        const fileEl = document.getElementById("fileInput");
        const pasteBtn = document.getElementById("pasteBtn");
        const exampleSel = document.getElementById("exampleSelect");
        const urlInput = document.getElementById("urlInput");
        const loadUrlBtn = document.getElementById("loadUrlBtn");
        const searchEl = document.getElementById("search");
        const printBtn = document.getElementById("printModeBtn");

        const onFile = (e)=>{
          const f = e.target.files?.[0];
          if (!f) return;
          const reader = new FileReader();
          reader.onload = ()=> {
            try { setBundle(JSON.parse(reader.result)); setErr(""); }
            catch(ex){ setErr("Invalid JSON in file."); }
          };
          reader.readAsText(f);
        };
        const onPaste = async ()=>{ setPasteText(""); setShowPaste(true); };
        const onLoadUrl = async ()=>{
          const url = urlInput.value.trim();
          if (!url) return;
          try{
            const res = await fetch(url);
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
            const json = await res.json();
            setBundle(json); setErr("");
          }catch(ex){
            setErr("Failed to load URL: " + ex.message);
          }
        };
        const onSearch = (e)=> setFilter(e.target.value.toLowerCase());
        const onPrintMode = ()=> setPrintMode(p=>!p);

        fileEl.addEventListener("change", onFile);
        pasteBtn.addEventListener("click", onPaste);
        exampleSel.addEventListener("change", onExampleChange);
        loadUrlBtn.addEventListener("click", onLoadUrl);
        searchEl.addEventListener("input", onSearch);
        printBtn.addEventListener("click", onPrintMode);

        return ()=> {
          fileEl.removeEventListener("change", onFile);
          pasteBtn.removeEventListener("click", onPaste);
          exampleSel.removeEventListener("change", onExampleChange);
          loadUrlBtn.removeEventListener("click", onLoadUrl);
          searchEl.removeEventListener("input", onSearch);
          printBtn.removeEventListener("click", onPrintMode);
        };
      },[]);

      // Load examples index (if present) and auto-load first example; else fallback demo
      useEffect(()=>{
        (async ()=>{
          try{
            const ix = await fetch("examples/index.json", {cache:"no-store"});
            const sel = document.getElementById('exampleSelect');
            if (ix.ok) {
              const data = await ix.json();
              const arr = Array.isArray(data.examples) ? data.examples : [];
              setExamples(arr);
              if (sel) {
                if (arr.length) {
                  sel.innerHTML = '<option value="">Examples…</option>' + arr.map((it, i)=>`<option value="${i}">${it.name}</option>`).join('');
                  sel.style.display = 'inline-block';
                  // Auto-load first example
                  setBundle(arr[0]?.content || null);
                  setErr("");
                  return;
                } else {
                  sel.style.display = 'none';
                }
              }
            } else if (sel) {
              sel.style.display = 'none';
            }
            // Fallback to prior default demo
            const res = await fetch("examples/pirate-angina.json", {cache:"no-store"});
            if (res.ok) { const json = await res.json(); setBundle(json); setErr(""); }
            if (sel) sel.style.display='none';
          } catch {}
        })();
      },[]);

      const index = useMemo(()=> bundle ? buildIndex(bundle) : null, [bundle]);
      const filtered = useMemo(()=>{
        if (!bundle) return null;
        if (!filter) return index.all;
        return index.all.filter(r => resourceSummaryText(r).includes(filter));
      }, [index, bundle, filter]);

      return (
        <div className="app">
          {showPaste && (
            <div style={{position:'fixed',inset:0,background:'#0008',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000}}>
              <div className="card" style={{maxWidth:'720px',width:'90%'}}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',gap:'.5rem',marginBottom:'.5rem'}}>
                  <strong>Paste Bundle JSON</strong>
                  <button className="button" onClick={()=>setShowPaste(false)}>Close</button>
                </div>
                <textarea style={{width:'100%',height:'40vh'}} value={pasteText} onInput={(e)=>setPasteText(e.target.value)} placeholder="{ &quot;resourceType&quot;: &quot;Bundle&quot;, ... }"></textarea>
                <div style={{display:'flex',gap:'.5rem',justifyContent:'flex-end',marginTop:'.5rem'}}>
                  <button className="button" onClick={()=>{
                    try { const obj = JSON.parse(pasteText); setBundle(obj); setErr(''); setShowPaste(false);} catch(ex){ setErr('Invalid JSON pasted.'); }
                  }}>Load</button>
                </div>
              </div>
            </div>
          )}
          <aside className="nav" aria-label="Navigator">
            <div className="group">
              <h3>Bundle</h3>
              {bundle ? (
                <ul>
                  <li><span className="badge">resourceType</span> <code className="kv">Bundle</code></li>
                  <li><span className="badge">type</span> <code className="kv">{bundle.type || "—"}</code></li>
                  <li><span className="badge">entries</span> <code className="kv">{bundle.entry?.length ?? 0}</code></li>
                </ul>
              ) : <div className="muted">Load a FHIR Bundle to begin.</div>}
            </div>

            {index?.composition && (
              <div className="group">
                <h3>Composition</h3>
                <ul>
                  <li><a href={"#"+resourceKey(index.composition)}>{index.composition.title || "Composition"}</a></li>
                </ul>
                {index.composition.section?.length ? (
                  <>
                    <h3>Sections</h3>
                    <ul>
                      {index.composition.section.map((s, i)=>(
                        <li key={i}><a href={`#section-${i+1}`}>{s.title || `Section ${i+1}`}</a></li>
                      ))}
                    </ul>
                  </>
                ) : null}
              </div>
            )}

            {bundle && (
              <div className="group">
                <h3>Resources</h3>
                {Object.entries(groupBy((filtered||[]), r=>r.resourceType))
                  .sort(([a],[b]) => a.localeCompare(b))
                  .map(([rt, list])=>(
                    <details key={rt} open>
                      <summary>{rt} <span className="muted">({list.length})</span></summary>
                      <ul>
                        {list.map(r=>(
                          <li key={resourceKey(r)}>
                            <a href={`#${resourceKey(r)}`}>{r.id || "(no id)"} {r.title ? `— ${r.title}` : ""}</a>
                          </li>
                        ))}
                      </ul>
                    </details>
                ))}
              </div>
            )}
          </aside>

          <main className="content">
            {err && <div className="card error">⚠️ {err}</div>}
            {bundle ? (
              <>
                <BundleHeader bundle={bundle} />
                {index?.composition && (
                  <CompositionViewer
                    composition={index.composition}
                    index={index}
                  />
                )}

                <div className="stickyTop">
                  <div className="search">
                    <span className="muted">Showing {filtered.length} of {index.all.length} resources</span>
                  </div>
                  <div className="divider"></div>
                </div>

                {filtered.map(r=>(
                  <ResourceCard
                    key={resourceKey(r)}
                    resource={r}
                    index={index}
                    printMode={printMode}
                  />
                ))}
              </>
            ) : (
              <div className="card">
                <h2>Welcome 👋</h2>
                <p>Load a FHIR <code>Bundle</code> (type <code>document</code>) via <strong>Open File</strong>, <strong>Paste JSON</strong>, or <strong>Load URL</strong>. If available, this viewer automatically loads <code>examples/pirate-angina.json</code>.</p>
                <p className="hint">This viewer is client‑side only, designed for scrolling and printing. No data leaves your browser.</p>
              </div>
            )}
          </main>
        </div>
      );
    }

    // ---------- Components ----------
    function BundleHeader({bundle}){
      const ident = bundle.identifier ? [bundle.identifier.system, bundle.identifier.value].filter(Boolean).join(" • ") : null;
      return (
        <div className="card">
          <h2 style={{margin:"0 0 .25rem"}}>Bundle <small className="muted">({bundle.type || "—"})</small></h2>
          <div className="meta">
            {bundle.id && <div><span className="badge">id</span> <code className="kv">{bundle.id}</code></div>}
            {ident && <div><span className="badge">identifier</span> <span>{ident}</span></div>}
            {bundle.timestamp && <div><span className="badge">timestamp</span> <span>{fmtDate(bundle.timestamp)}</span></div>}
          </div>
        </div>
      );
    }

    function CompositionViewer({composition, index}){
      const subject = composition.subject?.reference && resolveReference(composition.subject.reference, index);
      const encounter = composition.encounter?.reference && resolveReference(composition.encounter.reference, index);
      return (
        <div className="card resource" id={resourceKey(composition)}>
          <div className="rhead">
            <div className="rtitle">Composition <small>{composition.title || ""}</small></div>
            <div className="muted">{fmtDate(composition.date)}</div>
          </div>
          <div className="grid" style={{marginBottom:".5rem"}}>
            <div className="kvrow"><span className="badge">status</span> <code className="kv">{composition.status || "—"}</code></div>
            {subject && <div className="kvrow"><span className="badge">subject</span> <a href={`#${resourceKey(subject)}`}>{subject.id || resourceKey(subject)}</a></div>}
            {encounter && <div className="kvrow"><span className="badge">encounter</span> <a href={`#${resourceKey(encounter)}`}>{encounter.id || resourceKey(encounter)}</a></div>}
            {composition.author?.length ? (
              <div className="kvrow"><span className="badge">author</span> <span>
                {composition.author.map((a,i)=>{
                  const r = a.reference && resolveReference(a.reference, index);
                  return <span key={i} style={{marginRight:".5rem"}}>{r ? <a href={`#${resourceKey(r)}`}>{r.id || resourceKey(r)}</a> : (a.display || a.reference)}</span>;
                })}
              </span></div>
            ) : null}
          </div>

          {composition.section?.length ? (
            <>
              <div className="divider"></div>
              <h3 style={{margin:"0 0 .5rem"}}>Sections</h3>
              {composition.section.map((s, i) => (
                <SectionBlock key={i} s={s} i={i} index={index} />
              ))}
            </>
          ) : <div className="muted">No sections.</div>}
        </div>
      );
    }

    function SectionBlock({s, i, index}){
      const html = sanitizeHTML(s.text?.div || "");
      return (
        <section className="section" id={`section-${i+1}`}>
          <h4>{s.title || `Section ${i+1}`}</h4>
          {html ? <div dangerouslySetInnerHTML={{__html: html}}></div> : <div className="muted">No narrative.</div>}
          {s.entry?.length ? (
            <>
              <div style={{height:".5rem"}}></div>
              <div aria-label="Section entries">
                <ReferencesList refs={s.entry.map((ent)=>({ref: ent.reference || ent.display}))} index={index} />
              </div>
            </>
          ) : null}
        </section>
      );
    }

    function RefChip({r}){
      return <a className="chip" href={`#${resourceKey(r)}`} title={resourceKey(r)}>
        <span className="rt">{r.resourceType}</span><strong>{r.id || "(no id)"}</strong>
      </a>;
    }

    function ReferencesList({refs, index}){
      const groups = new Map();
      const unresolved = [];
      for (const rr of refs){
        const target = resolveReference(rr.ref, index);
        if (target) {
          const rt = target.resourceType || 'Other';
          if (!groups.has(rt)) groups.set(rt, []);
          groups.get(rt).push(target);
        } else {
          unresolved.push(rr.ref);
        }
      }
      const order = [
        'Subject','Patient','Encounter','Practitioner','Condition','Observation','ServiceRequest','MedicationRequest','MedicationStatement','Procedure','Composition'
      ];
      const sorted = [...groups.entries()].sort(([a],[b])=>{
        const ai = order.indexOf(a); const bi = order.indexOf(b);
        return (ai===-1?999:ai) - (bi===-1?999:bi) || a.localeCompare(b);
      });
      const join = (arr) => arr.flatMap((node,i)=> i? [<span key={'s'+i} className="refsep">,</span>, node] : [node]);
      const rows = [];
      for (const [rt, list] of sorted){
        rows.push(
          <span key={rt+':k'} className="refkey badge">{rt}</span>,
          <span key={rt+':v'} className="refvals">{join(list.map(r=> <a key={resourceKey(r)} href={`#${resourceKey(r)}`}>{r.id || resourceKey(r)}</a>))}</span>
        );
      }
      if (unresolved.length){
        rows.push(
          <span key={'Unresolved:k'} className="refkey badge">Unresolved</span>,
          <span key={'Unresolved:v'} className="refvals">{join(unresolved.map((u,i)=> <span key={i} title="Unresolved reference">{u}</span>))}</span>
        );
      }
      return <div className="reftable">{rows}</div>;
    }

    function ResourceCard({resource, index, printMode}){
      const [showJSON, setShowJSON] = useState(false);
      const refs = useMemo(()=> collectReferences(resource), [resource]);

      const Summary = renderSummary(resource, index);

      return (
        <article className="card resource" id={resourceKey(resource)} aria-label={`${resource.resourceType} ${resource.id || ""}`}>
          <div className="rhead">
            <div className="rtitle">{resource.resourceType} {resource.id && <small>— {resource.id}</small>}</div>
            <div
              className="tabs"
              role="group"
              aria-label="Toggle JSON"
              onClick={()=>setShowJSON(v=>!v)}
              title="Click to show/hide JSON below"
            >
              <button className="tab" aria-selected="true">Summary</button>
              <button className="tab" aria-selected={showJSON}>JSON</button>
            </div>
          </div>

          <div className="summary" style={{display: "block"}}>
            {Summary}
            {refs.length ? (
              <>
                <div className="divider"></div>
                <div className="kvrow"><span className="badge">references</span></div>
                <ReferencesList refs={refs} index={index} />
              </>
            ) : null}
          </div>

          <div className="jsonview" style={{display: showJSON ? "block" : (printMode ? "block" : "none")}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:".5rem"}}>
              <span className="muted">Pretty‑printed JSON</span>
              <button className="btnlink" onClick={()=>{
                const txt = JSON.stringify(resource, null, 2);
                if (navigator.clipboard) navigator.clipboard.writeText(txt).catch(()=>alert("Copy failed."));
                else {
                  // fallback
                  const ta = document.createElement("textarea"); ta.value=txt; document.body.appendChild(ta); ta.select();
                  try{ document.execCommand("copy"); } catch{}
                  document.body.removeChild(ta);
                }
              }}>Copy JSON</button>
            </div>
            <pre className="json"><code>{JSON.stringify(resource, null, 2)}</code></pre>
          </div>

          <div style={{display:"flex",justifyContent:"space-between",marginTop:".5rem"}}>
            <a href={`#${resourceKey(resource)}`} className="muted">Permalink</a>
            <span className="muted">{resourceKey(resource)}</span>
          </div>
        </article>
      );
    }

    function renderSummary(r, index){
      switch(r.resourceType){
        case "Patient": return <PatientSummary r={r} />;
        case "Practitioner": return <PractitionerSummary r={r} />;
        case "Encounter": return <EncounterSummary r={r} />;
        case "Condition": return <ConditionSummary r={r} />;
        case "Observation": return <ObservationSummary r={r} />;
        case "ServiceRequest": return <ServiceRequestSummary r={r} />;
        case "MedicationRequest": return <MedicationRequestSummary r={r} />;
        case "MedicationStatement": return <MedicationStatementSummary r={r} />;
        case "Procedure": return <ProcedureSummary r={r} />;
        case "Composition": return <CompositionSummary r={r} index={index} />;
        default: return <GenericKV r={r} />;
      }
    }

    const KV = ({k,v}) => (
      <div className="kvrow"><span className="badge">{k}</span> <span>{v ?? <span className="muted">—</span>}</span></div>
    );

    function GenericKV({r, extras={}}){
      const base = [
        ["id", r.id],
        ["status", r.status],
        ["intent", r.intent],
        ["priority", r.priority],
        ["category", ccDisplay(r.category)],
        ["code", ccDisplay(r.code)],
        ["type", ccDisplay(r.type)],
        ["title", r.title],
      ].filter(([_,v])=>v!=null && v!=="");
      const ex = Object.entries(extras);
      return (
        <div className="grid">
          {[...base, ...ex].map(([k,v])=> <KV key={k} k={k} v={v} />)}
        </div>
      );
    }

    function PatientSummary({r}){
      const addr = r.address?.[0];
      const age = r.birthDate ? Math.floor((Date.now() - new Date(r.birthDate).getTime())/(365.25*24*60*60*1000)) : null;
      return (
        <>
          <div className="kvlist">
            <KV k="name" v={humanName(r)} />
            <KV k="gender" v={r.gender} />
            <KV k="birthDate" v={fmtDate(r.birthDate)} />
            {age!=null && <KV k="age" v={`${age} y`} />}
            {r.maritalStatus && <KV k="maritalStatus" v={ccDisplay(r.maritalStatus)} />}
          </div>
          {addr && <div style={{marginTop:'.25rem'}}><KV k="address" v={[addr.line?.join(" "), addr.city, addr.state, addr.postalCode, addr.country].filter(Boolean).join(", ")} /></div>}
        </>
      );
    }

    function PractitionerSummary({r}){
      const nm = humanName(r);
      return (
        <div className="kvlist">
          <KV k="name" v={nm} />
          {r.identifier?.length ? <KV k="identifier" v={`${r.identifier[0].system || ""} ${r.identifier[0].value || ""}`} /> : null}
          {r.telecom?.length ? <KV k="telecom" v={r.telecom.map(t=>`${t.system}: ${t.value}`).join(" • ")} /> : null}
          <KV k="gender" v={r.gender} />
        </div>
      );
    }

    function EncounterSummary({r}){
      const title = ccDisplay(r.type?.[0]) || ccDisplay(r.class) || 'Encounter';
      const when = [fmtDate(r.period?.start), fmtDate(r.period?.end)].filter(Boolean).join(' → ');
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{title}</div>
            {when && <div className="bigValue">{when}</div>}
          </div>
          <div className="kvlist">
            <KV k="status" v={r.status} />
            <KV k="class" v={ccDisplay(r.class)} />
            {r.serviceProvider?.reference && <KV k="provider" v={r.serviceProvider.reference} />}
          </div>
        </>
      );
    }

    function ConditionSummary({r}){
      const codeDisp = ccDisplay(r.code);
      const clin = r.clinicalStatus?.coding?.[0]?.display || r.clinicalStatus?.coding?.[0]?.code;
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{codeDisp}</div>
            {clin && <div className="bigValue">{clin}</div>}
          </div>
          <div className="kvlist">
            <KV k="verification" v={r.verificationStatus?.coding?.[0]?.display || r.verificationStatus?.coding?.[0]?.code} />
            <KV k="onset" v={fmtDate(r.onsetDateTime)} />
            <KV k="category" v={r.category?.[0]?.coding?.[0]?.display} />
            {r.severity?.coding?.[0] && <KV k="severity" v={r.severity.coding[0].display || r.severity.coding[0].code} />}
          </div>
        </>
      );
    }

    function ObservationSummary({r}){
      const value =
        r.valueQuantity ? qtyDisplay(r.valueQuantity) :
        r.valueCodeableConcept ? ccDisplay(r.valueCodeableConcept) :
        r.valueString ? r.valueString : null;
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{ccDisplay(r.code)}</div>
            {value && <div className="bigValue">{value}</div>}
          </div>
          <div className="kvlist">
            <KV k="status" v={r.status} />
            <KV k="effective" v={fmtDate(r.effectiveDateTime)} />
            {r.interpretation?.[0] && <KV k="interpretation" v={r.interpretation[0].coding?.[0]?.display || r.interpretation[0].coding?.[0]?.code} />}
            {r.category?.[0] && <KV k="category" v={r.category[0].coding?.[0]?.display} />}
          </div>
          {r.component?.length ? (
            <>
              <div className="divider"></div>
              <strong>Components</strong>
              <div className="grid" style={{marginTop:".5rem"}}>
                {r.component.map((c, i)=>(
                  <div key={i} style={{border:"1px solid var(--border)",borderRadius:".5rem",padding:".5rem"}}>
                    <div className="kvrow"><span className="badge">code</span> <span>{ccDisplay(c.code)}</span></div>
                    {c.valueQuantity && <div className="kvrow"><span className="badge">value</span> <span>{qtyDisplay(c.valueQuantity)}</span></div>}
                    {c.valueCodeableConcept && <div className="kvrow"><span className="badge">value</span> <span>{ccDisplay(c.valueCodeableConcept)}</span></div>}
                    {c.valueString && <div className="kvrow"><span className="badge">value</span> <span>{c.valueString}</span></div>}
                  </div>
                ))}
              </div>
            </>
          ) : null}
        </>
      );
    }

    function ServiceRequestSummary({r}){
      const when =
        r.occurrenceDateTime ? fmtDate(r.occurrenceDateTime) :
        r.occurrenceTiming?.event?.length ? r.occurrenceTiming.event.map(fmtDate).join(" • ") : null;
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{ccDisplay(r.code)}</div>
            {when && <div className="bigValue">{when}</div>}
          </div>
          <div className="kvlist">
            <KV k="status" v={r.status} />
            <KV k="intent" v={r.intent} />
            <KV k="priority" v={r.priority} />
            {r.reasonCode?.[0] && <KV k="reason" v={ccDisplay(r.reasonCode?.[0])} />}
          </div>
        </>
      );
    }

    function MedicationRequestSummary({r}){
      const med = ccDisplay(r.medicationCodeableConcept) || r.medicationReference?.reference || "—";
      const dose = r.dosageInstruction?.[0];
      const sigText = (dose?.text || r.patientInstruction || "").trim() || null;
      const doseQty = (dose?.doseAndRate?.[0]?.doseQuantity && qtyDisplay(dose.doseAndRate[0].doseQuantity)) || null;
      const freq = dose?.timing?.repeat?.frequency && `${dose.timing.repeat.frequency}×/${dose.timing.repeat.period}${dose.timing.repeat.periodUnit}`;
      const doseSummary = [doseQty, freq].filter(Boolean).join(" • ");
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{med}</div>
            {doseSummary && <div className="bigValue">{doseSummary}</div>}
          </div>
          {sigText && <div className="muted" style={{marginTop:'.1rem'}}>{sigText}</div>}
          <div className="kvlist">
            <KV k="status" v={r.status} />
            <KV k="intent" v={r.intent} />
            {dose?.route && <KV k="route" v={dose.route.coding?.[0]?.display} />}
            {r.note?.[0]?.text && <KV k="note" v={r.note[0].text} />}
          </div>
        </>
      );
    }

    function MedicationStatementSummary({r}){
      const med = ccDisplay(r.medicationCodeableConcept) || "—";
      const dose = r.dosage?.[0];
      const sigText = (dose?.text || "").trim() || null;
      const doseQty = (dose?.doseAndRate?.[0]?.doseQuantity && qtyDisplay(dose.doseAndRate[0].doseQuantity)) || null;
      const freq = dose?.timing?.repeat?.frequency && `${dose.timing.repeat.frequency}×/${dose.timing.repeat.period}${dose.timing.repeat.periodUnit}`;
      const doseSummary = [doseQty, freq].filter(Boolean).join(" • ");
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{med}</div>
            {doseSummary && <div className="bigValue">{doseSummary}</div>}
          </div>
          {sigText && <div className="muted" style={{marginTop:'.1rem'}}>{sigText}</div>}
          <div className="kvlist">
            <KV k="status" v={r.status} />
            {r.effectivePeriod?.start && <KV k="since" v={fmtDate(r.effectivePeriod.start)} />}
            {r.note?.[0]?.text && <KV k="note" v={r.note[0].text} />}
          </div>
        </>
      );
    }

    function CompositionSummary({r, index}){
      const subj = r.subject?.reference && resolveReference(r.subject.reference, index);
      const enc = r.encounter?.reference && resolveReference(r.encounter.reference, index);
      const meta = [r.status, ccDisplay(r.type)].filter(Boolean).join(" • ");
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{r.title || "Composition"}</div>
            {r.date && <div className="bigValue">{fmtDate(r.date)}</div>}
          </div>
          {meta && <div className="muted" style={{marginBottom:".4rem"}}>{meta}</div>}
          <div className="kvlist">
            {subj && <KV k="subject" v={<a href={`#${resourceKey(subj)}`}>{subj.id || resourceKey(subj)}</a>} />}
            {enc && <KV k="encounter" v={<a href={`#${resourceKey(enc)}`}>{enc.id || resourceKey(enc)}</a>} />}
            {r.author?.length && <KV k="author" v={(r.author || []).map((a,i)=>{
              const pr = a.reference && resolveReference(a.reference, index);
              return <span key={i} style={{marginRight:".5rem"}}>{pr ? <a href={`#${resourceKey(pr)}`}>{pr.id || resourceKey(pr)}</a> : (a.display || a.reference)}</span>;
            })} />}
          </div>
        </>
      );
    }

    function ProcedureSummary({r}){
      const when = r.performedDateTime ? fmtDate(r.performedDateTime)
        : (r.performedPeriod?.start || r.performedPeriod?.end)
          ? [fmtDate(r.performedPeriod?.start), fmtDate(r.performedPeriod?.end)].filter(Boolean).join(" → ")
          : null;
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{ccDisplay(r.code) || r.code?.text || r.id}</div>
            {when && <div className="bigValue">{when}</div>}
          </div>
          <div className="kvlist">
            <KV k="status" v={r.status} />
            {r.category && <KV k="category" v={ccDisplay(r.category)} />}
            {r.reasonCode?.[0] && <KV k="reason" v={ccDisplay(r.reasonCode[0])} />}
          </div>
        </>
      );
    }

        const onExampleChange = (e)=>{
          const idx = Number(e.target.value);
          if (isNaN(idx) || idx < 0) return;
          const item = examples[idx];
          if (item?.content) { setBundle(item.content); setErr(""); }
        };
    // ---------- helpers ----------
    function groupBy(items, keyFn){
      const m = {};
      for (const it of items){ const k = keyFn(it); (m[k] = m[k] || []).push(it); }
      return m;
    }

    // ---------- Render ----------
    const root = createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
